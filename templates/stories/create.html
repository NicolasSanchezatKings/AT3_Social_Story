{% extends "layout/base.html" %}

{% block content %}
<div class="container py-4">

    <h2 class="mb-3"><i class="bi bi-journal-richtext me-2"></i>Create Your Social Story</h2>

    <form method="POST" enctype="multipart/form-data" id="story-form" novalidate>
        {{ form.hidden_tag() }}

        <div class="mb-3">
            {{ form.title.label(class="form-label") }}
            {{ form.title(class="form-control", id="title", placeholder="My Social Story Title") }}
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="d-flex flex-wrap gap-2 align-items-center mb-3 border rounded p-2 bg-white shadow-sm">
            <!-- Page Controls -->
            <div>
                <button type="button" class="btn btn-outline-success btn-sm" id="btn-add-page" title="Add Page">+ Add Page</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="btn-remove-page" title="Remove Current Page">âˆ’ Remove Page</button>
            </div>

            <!-- Image Upload -->
            <div>
                <label class="btn btn-outline-primary btn-sm mb-0" for="globalImageInput" title="Upload Images">
                    <i class="bi bi-image me-1"></i> Choose File
                </label>
                <input type="file" id="globalImageInput" accept="image/*" hidden multiple>
            </div>

            <!-- Text Formatting Buttons -->
            <div class="btn-group btn-group-sm" role="group" aria-label="Basic formatting">
                <button type="button" class="btn btn-outline-secondary" data-cmd="bold" title="Bold"><strong>B</strong></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="italic" title="Italic"><em>I</em></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="underline" title="Underline"><u>U</u></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Text alignment">
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyLeft" title="Align Left"><i class="bi bi-text-left"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyCenter" title="Align Center"><i class="bi bi-text-center"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyRight" title="Align Right"><i class="bi bi-text-right"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyFull" title="Justify"><i class="bi bi-justify"></i></button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Lists">
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertUnorderedList" title="Bullet List"><i class="bi bi-list-ul"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertOrderedList" title="Numbered List"><i class="bi bi-list-ol"></i></button>
            </div>

            <!-- Font Family -->
            <select id="font-family" class="form-select form-select-sm w-auto" title="Font Family" aria-label="Font Family Selector">
                <option value="Arial" selected>Arial</option>
                <option value="Courier New">Courier New</option>
                <option value="Georgia">Georgia</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Verdana">Verdana</option>
            </select>

            <!-- Font Size -->
            <select id="font-size" class="form-select form-select-sm w-auto" title="Font Size" aria-label="Font Size Selector">
                <option value="1">8pt</option>
                <option value="2">10pt</option>
                <option value="3" selected>12pt</option>
                <option value="4">14pt</option>
                <option value="5">18pt</option>
                <option value="6">24pt</option>
                <option value="7">36pt</option>
            </select>

            <!-- Text Color -->
            <input type="color" id="fore-color" class="form-control form-control-color w-auto" title="Text Color" aria-label="Text Color Picker" value="#000000" style="height:34px;">

            <!-- Highlight Color -->
            <input type="color" id="hilite-color" class="form-control form-control-color w-auto" title="Highlight Color" aria-label="Highlight Color Picker" value="#ffff00" style="height:34px;">

            <!-- Undo / Redo -->
            <div class="btn-group btn-group-sm ms-auto" role="group" aria-label="Undo / Redo">
                <button type="button" class="btn btn-outline-secondary" id="undo" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="redo" title="Redo"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>

        <!-- Page Customization -->
        <div class="d-flex gap-3 align-items-center mb-3">
            <label for="page-bg-color" class="mb-0">Page Background Color:</label>
            <input type="color" id="page-bg-color" value="#ffffff" title="Change Page Background Color">

            <label for="page-bg-image" class="mb-0">Page Background Image:</label>
            <input type="file" id="page-bg-image" accept="image/*" title="Upload Page Background Image">

            <label for="page-size" class="mb-0">Page Size:</label>
            <select id="page-size" class="form-select form-select-sm w-auto" title="Select Page Size">
                <option value="A5" selected>A5 (148x210 mm)</option>
                <option value="A4">A4 (210x297 mm)</option>
                <option value="Letter">Letter (8.5x11 in)</option>
            </select>

            <label for="page-orientation" class="mb-0">Orientation:</label>
            <select id="page-orientation" class="form-select form-select-sm w-auto" title="Select Page Orientation">
                <option value="portrait" selected>Portrait</option>
                <option value="landscape">Landscape</option>
            </select>
        </div>

        <!-- Book Container -->
        <div id="book-wrapper" class="position-relative mx-auto" tabindex="0" style="outline:none;">
            <div id="book-page-container" class="book-page-flip" aria-live="polite" aria-atomic="true" aria-relevant="additions removals">
                <!-- Pages inserted here dynamically -->
            </div>
            <button type="button" id="prev-page" class="btn btn-outline-secondary position-absolute top-50 start-0 translate-middle-y" aria-label="Previous Page">&larr;</button>
            <button type="button" id="next-page" class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y" aria-label="Next Page">&rarr;</button>
        </div>

        <div class="form-check mt-4">
            {{ form.is_published(class="form-check-input") }}
            {{ form.is_published.label(class="form-check-label") }}
        </div>

        <div class="d-flex gap-2 mt-3">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('stories.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Stories
            </a>
            <button type="button" class="btn btn-outline-info" id="preview-button">
                <i class="bi bi-eye me-1"></i>Preview
            </button>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Storybook Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="preview-content" class="d-flex flex-wrap justify-content-center gap-4 p-3" style="background:#e7e9ed; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
/* --- Book Container & Pages --- */
#book-wrapper {
    max-width: 680px;
    min-height: 480px;
    margin: auto;
    position: relative;
    overflow: visible;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fefefe;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    user-select: none;
}

#book-page-container {
    height: 460px;
    position: relative;
    perspective: 1600px;
    overflow: visible;
}

.book-page {
    width: 100%;
    height: 100%;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 14px;
    padding: 16px;
    box-shadow:
        inset 0 0 10px #fafafa,
        0 6px 12px rgba(0,0,0,0.1);
    position: absolute;
    top: 0;
    left: 0;
    transform-style: preserve-3d;
    backface-visibility: hidden;
    transition: box-shadow 0.3s ease;
    z-index: 1;
    display: none;
    overflow: auto;
}

.book-page.active {
    display: block;
    z-index: 5;
    transform: rotateY(0deg);
    box-shadow:
        inset 0 0 18px #fff,
        0 14px 24px rgba(0,0,0,0.25);
    user-select: text;
}

/* Page flipping animation */

.book-page.animate-flip-next {
    animation: pageFlipNext 0.8s forwards;
    transform-origin: left center;
    z-index: 10 !important;
}

.book-page.animate-flip-prev {
    animation: pageFlipPrev 0.8s forwards;
    transform-origin: right center;
    z-index: 10 !important;
}

@keyframes pageFlipNext {
    0% {
        transform: rotateY(0deg);
        box-shadow: 0 14px 24px rgba(0,0,0,0.25);
    }
    50% {
        transform: rotateY(-90deg);
        box-shadow: 0 0 40px rgba(0,0,0,0.4);
    }
    100% {
        transform: rotateY(-180deg);
        box-shadow: 0 0 0 transparent;
        visibility: hidden;
    }
}

@keyframes pageFlipPrev {
    0% {
        transform: rotateY(0deg);
        box-shadow: 0 14px 24px rgba(0,0,0,0.25);
    }
    50% {
        transform: rotateY(90deg);
        box-shadow: 0 0 40px rgba(0,0,0,0.4);
    }
    100% {
        transform: rotateY(180deg);
        box-shadow: 0 0 0 transparent;
        visibility: hidden;
    }
}

/* Page body text */
.page-body {
    width: 100%;
    height: 100%;
    outline: none;
    font-size: 1.1rem;
    line-height: 1.5;
    color: #333;
    background: transparent;
    border-radius: 8px;
    padding: 10px 14px;
    overflow-y: auto;
    user-select: text;
    white-space: pre-wrap;
    font-family: inherit;
}

/* Resizable images */
.resizable {
    position: absolute;
    border: 2px solid #bbb;
    background: #fff;
    border-radius: 6px;
    overflow: hidden;
    cursor: move;
    user-select: none;
    z-index: 20;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

/* Image styling */
.resizable img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
}

/* Image controls container */
.image-controls {
    position: absolute;
    bottom: -36px;
    left: 0;
    display: flex;
    gap: 6px;
    user-select: none;
}

/* Control buttons */
.image-controls button {
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #f7f7f7;
    color: #333;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.image-controls button:hover {
    background-color: #ddd;
}

/* Remove image button (fixed position to avoid cutoff) */
.remove-btn {
    position: absolute;
    top: -14px;
    right: -14px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    line-height: 28px;
    padding: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 25;
}

/* Navigation buttons */
#prev-page, #next-page {
    width: 38px;
    height: 48px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.85;
    transition: opacity 0.3s ease;
    font-weight: 700;
    font-size: 1.5rem;
    user-select: none;
    z-index: 50;
}

#prev-page:hover, #next-page:hover {
    opacity: 1;
}

#prev-page {
    left: -48px;
}

#next-page {
    right: -48px;
}

/* Preview styling */
#preview-content {
    min-height: 100px;
}

#preview-content .book-page {
    position: relative !important;
    width: 320px !important;
    height: 460px !important;
    margin-bottom: 20px;
    box-shadow:
        0 8px 16px rgba(0,0,0,0.25);
    border: 2px solid #bbb !important;
    border-radius: 12px !important;
    transform: none !important;
    display: block !important;
    user-select: none;
}

/* Preview page body text */
#preview-content .page-body {
    outline: none;
    cursor: default;
    user-select: text;
}

/* Drag-and-drop preview page style */
.draggable-preview-page {
    cursor: grab;
}

.draggable-preview-page:active {
    cursor: grabbing;
}

/* Remove file chosen text */
label[for="globalImageInput"] {
    cursor: pointer;
    user-select: none;
}

label[for="globalImageInput"]::after {
    content: "";
}

/* Scrollbar styling for contenteditable */
.page-body::-webkit-scrollbar {
    width: 8px;
}
.page-body::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}
.page-body::-webkit-scrollbar-track {
    background: #f9f9f9;
}

/* Active formatting buttons highlight */
.btn-outline-secondary.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
(() => {
    // State variables
    let pages = [];
    let currentPageIndex = 0;
    let isAnimating = false;
    let undoStack = [];
    let redoStack = [];

    const bookContainer = document.getElementById('book-page-container');
    const titleInput = document.getElementById('title');
    const globalImageInput = document.getElementById('globalImageInput');
    const pageBgColorInput = document.getElementById('page-bg-color');
    const pageBgImageInput = document.getElementById('page-bg-image');
    const pageSizeSelect = document.getElementById('page-size');
    const pageOrientationSelect = document.getElementById('page-orientation');
    const previewButton = document.getElementById('preview-button');

    // Undo/Redo helper functions
    function saveState() {
        // Deep clone pages content
        const state = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        undoStack.push(state);
        if (undoStack.length > 100) undoStack.shift();
        redoStack = []; // Clear redo on new action
        updateUndoRedoButtons();
    }
    function restoreState(state) {
        pages.forEach((page, idx) => {
            if (!state[idx]) return;
            const pb = page.querySelector('.page-body');
            pb.innerHTML = state[idx].html;
            page.style.backgroundColor = state[idx].bgColor;
            page.style.backgroundImage = state[idx].bgImage;
            page.setAttribute('data-page-size', state[idx].pageSize);
            page.setAttribute('data-orientation', state[idx].orientation);
            applyPageSizeOrientation(page);
            // Remove existing images
            const existingImgs = page.querySelectorAll('.resizable');
            existingImgs.forEach(e => e.remove());
            // Add images
            state[idx].images.forEach(imgData => {
                const imgContainer = createResizableImage(imgData.src);
                imgContainer.style = imgData.style || '';
                imgContainer.style.zIndex = imgData.zIndex || '20';
                imgContainer.setAttribute('data-x', imgData.dataX);
                imgContainer.setAttribute('data-y', imgData.dataY);
                applyTransform(imgContainer, parseFloat(imgData.dataX), parseFloat(imgData.dataY));
                page.appendChild(imgContainer);
                enableInteract(imgContainer);
            });
        });
    }
    function undo() {
        if (undoStack.length === 0) return;
        const currentState = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        redoStack.push(currentState);
        const lastState = undoStack.pop();
        restoreState(lastState);
        updateUndoRedoButtons();
    }
    function redo() {
        if (redoStack.length === 0) return;
        const currentState = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        undoStack.push(currentState);
        const nextState = redoStack.pop();
        restoreState(nextState);
        updateUndoRedoButtons();
    }
    function updateUndoRedoButtons() {
        undoBtn.disabled = undoStack.length === 0;
        redoBtn.disabled = redoStack.length === 0;
    }

    // Create a new page element
    function createPage() {
        const page = document.createElement('div');
        page.classList.add('book-page');
        page.setAttribute('data-page-size', 'A5');
        page.setAttribute('data-orientation', 'portrait');
        page.style.backgroundColor = '#fff';

        const pageBody = document.createElement('div');
        pageBody.className = 'page-body';
        pageBody.contentEditable = 'true';
        pageBody.setAttribute('aria-label', 'Page content');
        pageBody.spellcheck = false;
        pageBody.style.position = 'relative';
        pageBody.style.minHeight = '100%';
        page.appendChild(pageBody);

        // Allow typing and keep selection on formatting
        pageBody.addEventListener('input', () => saveState());
        pageBody.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'z')) {
                e.preventDefault();
                undo();
            } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y')) {
                e.preventDefault();
                redo();
            }
        });

        return page;
    }

    // Show page by index with flip animation
    function showPage(index, direction = 'next') {
        if (isAnimating || index < 0 || index >= pages.length || index === currentPageIndex) return;
        isAnimating = true;

        const current = pages[currentPageIndex];
        const next = pages[index];

        // Prepare next page
        next.style.display = 'block';
        next.style.zIndex = 20;
        next.classList.add('active');

        // Animation classes
        if (direction === 'next') {
            current.classList.add('animate-flip-next');
            setTimeout(() => {
                current.style.display = 'none';
                current.classList.remove('active', 'animate-flip-next');
                current.style.zIndex = 1;

                next.style.transform = 'rotateY(0deg)';
                currentPageIndex = index;
                isAnimating = false;
                updatePageControls();
                saveState();
            }, 800);
        } else {
            current.classList.add('animate-flip-prev');
            setTimeout(() => {
                current.style.display = 'none';
                current.classList.remove('active', 'animate-flip-prev');
                current.style.zIndex = 1;

                next.style.transform = 'rotateY(0deg)';
                currentPageIndex = index;
                isAnimating = false;
                updatePageControls();
                saveState();
            }, 800);
        }
    }

    // Update navigation button states
    function updatePageControls() {
        prevBtn.disabled = currentPageIndex === 0;
        nextBtn.disabled = currentPageIndex === pages.length - 1;
    }

    // Add image to current page
    function addImageToPage(src) {
        if (!pages[currentPageIndex]) return;
        const page = pages[currentPageIndex];
        const imgContainer = createResizableImage(src);
        page.appendChild(imgContainer);
        enableInteract(imgContainer);
        saveState();
    }

    // Create a resizable, draggable image container
    function createResizableImage(src) {
        const container = document.createElement('div');
        container.classList.add('resizable');
        container.style.width = '180px';
        container.style.height = '120px';
        container.style.top = '50px';
        container.style.left = '50px';
        container.style.position = 'absolute';
        container.style.zIndex = 20;
        container.setAttribute('data-x', '0');
        container.setAttribute('data-y', '0');

        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Inserted Image';
        container.appendChild(img);

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '&times;';
        removeBtn.classList.add('remove-btn');
        removeBtn.title = 'Remove Image';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            container.remove();
            saveState();
        });
        container.appendChild(removeBtn);

        // Layer controls container
        const controls = document.createElement('div');
        controls.className = 'image-controls';

        const bringForwardBtn = document.createElement('button');
        bringForwardBtn.title = 'Bring Forward';
        bringForwardBtn.innerHTML = '<i class="bi bi-arrow-up"></i>';
        bringForwardBtn.type = 'button';
        bringForwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            container.style.zIndex = currentZ + 1;
            saveState();
        });

        const sendBackwardBtn = document.createElement('button');
        sendBackwardBtn.title = 'Send Backward';
        sendBackwardBtn.innerHTML = '<i class="bi bi-arrow-down"></i>';
        sendBackwardBtn.type = 'button';
        sendBackwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            if (currentZ > 1) container.style.zIndex = currentZ - 1;
            saveState();
        });

        controls.appendChild(bringForwardBtn);
        controls.appendChild(sendBackwardBtn);
        container.appendChild(controls);

        return container;
    }

    // Apply CSS transform to position container
    function applyTransform(el, x, y) {
        el.style.transform = `translate(${x}px, ${y}px)`;
        el.setAttribute('data-x', x);
        el.setAttribute('data-y', y);
    }

    // Enable interact.js draggable and resizable on image containers
    function enableInteract(target) {
        interact(target)
            .draggable({
                listeners: {
                    move(event) {
                        const el = event.target;
                        let x = (parseFloat(el.getAttribute('data-x')) || 0) + event.dx;
                        let y = (parseFloat(el.getAttribute('data-y')) || 0) + event.dy;
                        applyTransform(el, x, y);
                    },
                    end(event) {
                        saveState();
                    }
                },
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: 'parent',
                        endOnly: true
                    })
                ],
                inertia: true
            })
            .resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                listeners: {
                    move(event) {
                        let width = event.rect.width;
                        let height = event.rect.height;

                        // Update the element's style
                        event.target.style.width = width + 'px';
                        event.target.style.height = height + 'px';

                        // Translate when resizing from top or left edges
                        let x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.deltaRect.left;
                        let y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.deltaRect.top;

                        applyTransform(event.target, x, y);
                    },
                    end(event) {
                        saveState();
                    }
                },
                modifiers: [
                    interact.modifiers.restrictEdges({
                        outer: 'parent',
                        endOnly: true
                    }),
                    interact.modifiers.restrictSize({
                        min: { width: 60, height: 40 },
                        max: { width: 600, height: 600 }
                    })
                ],
                inertia: true
            });
    }

    // Initialize toolbar buttons for text formatting
    const toolbar = document.getElementById('toolbar');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeSelect = document.getElementById('font-size');
    const foreColorInput = document.getElementById('fore-color');
    const hiliteColorInput = document.getElementById('hilite-color');
    const undoBtn = document.getElementById('undo');
    const redoBtn = document.getElementById('redo');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const btnAddPage = document.getElementById('btn-add-page');
    const btnRemovePage = document.getElementById('btn-remove-page');

    // Commands with execCommand fallback (execCommand deprecated but works)
    toolbar.addEventListener('click', e => {
        const btn = e.target.closest('button[data-cmd]');
        if (!btn) return;
        const cmd = btn.dataset.cmd;

        // Special handling for text alignment and lists - execCommand handles those as well
        document.execCommand(cmd, false, null);
        updateToolbarState();
        saveState();
    });

    // Font family change
    fontFamilySelect.addEventListener('change', () => {
        document.execCommand('fontName', false, fontFamilySelect.value);
        updateToolbarState();
        saveState();
    });

    // Font size change
    fontSizeSelect.addEventListener('change', () => {
        document.execCommand('fontSize', false, fontSizeSelect.value);
        updateToolbarState();
        saveState();
    });

    // Foreground color change
    foreColorInput.addEventListener('input', () => {
        document.execCommand('foreColor', false, foreColorInput.value);
        updateToolbarState();
        saveState();
    });

    // Highlight color change
    hiliteColorInput.addEventListener('input', () => {
        document.execCommand('hiliteColor', false, hiliteColorInput.value);
        updateToolbarState();
        saveState();
    });

    // Undo/Redo buttons
    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    // Update toolbar button active states
    function updateToolbarState() {
        const commands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertUnorderedList', 'insertOrderedList'];
        commands.forEach(cmd => {
            const button = toolbar.querySelector(`button[data-cmd="${cmd}"]`);
            if (!button) return;
            if (document.queryCommandState(cmd)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // Update on selection change
    document.addEventListener('selectionchange', () => {
        updateToolbarState();
    });

    // Add page
    btnAddPage.addEventListener('click', () => {
        const page = createPage();
        pages.push(page);
        bookContainer.appendChild(page);
        showPage(pages.length - 1, 'next');
        saveState();
        updatePageControls();
    });

    // Remove current page
    btnRemovePage.addEventListener('click', () => {
        if (pages.length <= 1) {
            alert('Cannot remove the last page.');
            return;
        }
        pages[currentPageIndex].remove();
        pages.splice(currentPageIndex, 1);
        if (currentPageIndex >= pages.length) currentPageIndex = pages.length - 1;
        showPage(currentPageIndex, 'prev');
        saveState();
        updatePageControls();
    });

    // Prev/Next buttons
    prevBtn.addEventListener('click', () => {
        showPage(currentPageIndex - 1, 'prev');
    });

    nextBtn.addEventListener('click', () => {
        showPage(currentPageIndex + 1, 'next');
    });

    // Global image upload
    globalImageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (!files.length) return;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                addImageToPage(event.target.result);
            };
            reader.readAsDataURL(file);
        });
        globalImageInput.value = null;
    });

    // Page background color change
    pageBgColorInput.addEventListener('input', () => {
        if (!pages[currentPageIndex]) return;
        pages[currentPageIndex].style.backgroundColor = pageBgColorInput.value;
        // Remove bg image if color changed
        pages[currentPageIndex].style.backgroundImage = '';
        saveState();
    });

    // Page background image upload
    pageBgImageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            if (!pages[currentPageIndex]) return;
            pages[currentPageIndex].style.backgroundImage = `url('${event.target.result}')`;
            pages[currentPageIndex].style.backgroundSize = 'cover';
            pages[currentPageIndex].style.backgroundPosition = 'center center';
            saveState();
        };
        reader.readAsDataURL(file);
        pageBgImageInput.value = null;
    });

    // Page size change
    pageSizeSelect.addEventListener('change', () => {
        if (!pages[currentPageIndex]) return;
        const size = pageSizeSelect.value;
        pages[currentPageIndex].setAttribute('data-page-size', size);
        applyPageSizeOrientation(pages[currentPageIndex]);
        saveState();
    });

    // Page orientation change
    pageOrientationSelect.addEventListener('change', () => {
        if (!pages[currentPageIndex]) return;
        const orientation = pageOrientationSelect.value;
        pages[currentPageIndex].setAttribute('data-orientation', orientation);
        applyPageSizeOrientation(pages[currentPageIndex]);
        saveState();
    });

    // Apply page size and orientation CSS styles
    function applyPageSizeOrientation(page) {
        const size = page.getAttribute('data-page-size') || 'A5';
        const orientation = page.getAttribute('data-orientation') || 'portrait';

        // Dimensions in px approx for screen display (1mm ~ 3.78px)
        const sizes = {
            A5: { width: 148 * 3.78, height: 210 * 3.78 },
            A4: { width: 210 * 3.78, height: 297 * 3.78 },
            Letter: { width: 8.5 * 96, height: 11 * 96 }
        };

        let w = sizes[size].width;
        let h = sizes[size].height;

        if (orientation === 'landscape') [w, h] = [h, w];

        page.style.width = w + 'px';
        page.style.height = h + 'px';
    }

    // Preview modal logic
    previewButton.addEventListener('click', () => {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = ''; // Clear

        pages.forEach((page, idx) => {
            const clone = page.cloneNode(true);
            clone.classList.remove('active');
            clone.style.position = 'relative';
            clone.style.width = '320px';
            clone.style.height = '460px';
            clone.style.margin = '0 auto 20px auto';
            clone.style.transform = 'none';
            clone.style.boxShadow = '0 8px 16px rgba(0,0,0,0.25)';
            clone.style.border = '2px solid #bbb';
            clone.style.borderRadius = '12px';
            // Remove interactjs listeners & controls from cloned images for preview
            clone.querySelectorAll('.resizable').forEach(img => {
                img.style.cursor = 'default';
                const controls = img.querySelector('.image-controls');
                if (controls) controls.remove();
                const removeBtn = img.querySelector('.remove-btn');
                if (removeBtn) removeBtn.remove();
            });
            // Disable editing in preview
            const pageBody = clone.querySelector('.page-body');
            pageBody.contentEditable = false;
            previewContent.appendChild(clone);
        });

        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        previewModal.show();
    });

    // Initialize with one page
    function init() {
        const firstPage = createPage();
        pages.push(firstPage);
        bookContainer.appendChild(firstPage);
        firstPage.classList.add('active');
        applyPageSizeOrientation(firstPage);
        updatePageControls();
        saveState();
        updateUndoRedoButtons();
    }

    // Initialize
    init();

})();
</script>
{% endblock %}
