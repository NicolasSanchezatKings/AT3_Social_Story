{% extends "layout/base.html" %}

{% block content %}
<span id="story-data-json" data-story-json='{{ story_data|tojson|safe }}' style="display:none;"></span>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">{{ story.title }}</h4>
                    {% if story.is_published %}
                        <span class="badge bg-success mt-1">Published</span>
                    {% else %}
                        <span class="badge bg-secondary mt-1">Draft</span>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('stories.edit', id=story.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printStory()">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="story-content" id="story-content">
                    <div id="story-preview-container"></div>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>
                            Created {{ story.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </small>
                        {% if story.updated_at != story.created_at %}
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-pencil me-1"></i>
                            Last updated {{ story.updated_at.strftime('%B %d, %Y') }}
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('stories.index') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back to Stories
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
<script>
// Render the story using the same deserializeBook logic as the editor
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('story-preview-container');
    const storyDataSpan = document.getElementById('story-data-json');
    let data = [];
    if (storyDataSpan) {
        let raw = storyDataSpan.getAttribute('data-story-json');
        try {
            // If raw is already an array, use it directly
            if (raw && raw[0] === '[') {
                data = JSON.parse(raw);
            } else if (raw && raw !== 'null') {
                // Try to parse as JSON string
                data = JSON.parse(raw);
            }
        } catch (e) {
            data = [];
        }
    }
    if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="text-danger">No story content found.</div>';
        return;
    }
    data.forEach(function(pageData) {
        const page = document.createElement('div');
        page.className = 'book-page';
        page.style.backgroundColor = pageData.bgColor || '#fff';
        page.style.backgroundImage = pageData.bgImage || '';
        page.style.backgroundSize = pageData.bgSize || 'cover';
        page.style.backgroundRepeat = pageData.bgRepeat || 'no-repeat';
        page.style.backgroundPosition = pageData.bgPosition || 'center';
        page.style.width = '320px';
        page.style.height = '460px';
        page.style.margin = '0 8px 20px 8px';
        page.style.display = 'inline-block';
        page.style.verticalAlign = 'top';
        page.style.position = 'relative';
        page.style.border = '2px solid #bbb';
        page.style.borderRadius = '12px';
        page.setAttribute('data-page-size', pageData.pageSize || 'A5');
        page.setAttribute('data-orientation', pageData.orientation || 'portrait');
        // Page body
        const pb = document.createElement('div');
        pb.className = 'page-body';
        pb.innerHTML = pageData.html || '';
        pb.style.position = 'relative';
        pb.style.minHeight = '100%';
        page.appendChild(pb);
        // Images
        (pageData.images || []).forEach(function(imgData) {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'resizable';
            imgContainer.style.position = imgData.style?.position || 'absolute';
            imgContainer.style.top = imgData.style?.top || '50px';
            imgContainer.style.left = imgData.style?.left || '50px';
            imgContainer.style.width = imgData.style?.width || '180px';
            imgContainer.style.height = imgData.style?.height || '120px';
            imgContainer.style.zIndex = imgData.zIndex || '20';
            imgContainer.style.float = imgData.style?.float || 'left';
            imgContainer.style.margin = imgData.style?.margin || '8px 16px 8px 0';
            // Image
            const img = document.createElement('img');
            img.src = imgData.src;
            img.alt = 'Page image';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            imgContainer.appendChild(img);
            page.appendChild(imgContainer);
        });
        container.appendChild(page);
    });
});
</script>
        <!-- Story Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Story Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('stories.edit', id=story.id) }}" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Edit Story
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="copyStoryLink()">
                        <i class="bi bi-link-45deg me-2"></i>Copy Link
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printStory()">
                        <i class="bi bi-printer me-2"></i>Print Story
                    </button>
                    <hr>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-2"></i>Delete Story
                    </button>
                </div>
                
                <!-- Hidden delete form -->
                <form id="delete-form" action="{{ url_for('stories.delete', id=story.id) }}" method="GET" style="display: none;">
                </form>
            </div>
        </div>
        
        <!-- Story Stats -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>Story Information
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <strong>Word Count:</strong>
                        <span id="word-count">{{ story.content.split()|length }}</span> words
                    </li>
                    <li class="mb-2">
                        <strong>Character Count:</strong>
                        <span id="char-count">{{ story.content|length }}</span> characters
                    </li>
                    <li class="mb-2">
                        <strong>Reading Time:</strong>
                        <span id="reading-time">~{{ ((story.content.split()|length / 200) * 60)|round|int }} seconds</span>
                    </li>
                    <li class="mb-2">
                        <strong>Status:</strong>
                        {% if story.is_published %}
                            <span class="text-success">Published</span>
                        {% else %}
                            <span class="text-muted">Draft</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function printStory() {
    const printWindow = window.open('', '_blank');
    const storyTitle = '{{ story.title|e }}';
    // Escape backticks and ${} in storyContent to avoid breaking the template literal
    let storyContent = document.getElementById('story-content').innerHTML
        .replace(/`/g, '\\`')
        .replace(/\$\{/g, '\\${');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${storyTitle}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    line-height: 1.6; 
                    max-width: 800px; 
                    margin: 0 auto; 
                    padding: 20px; 
                }
                h1 { 
                    border-bottom: 2px solid #333; 
                    padding-bottom: 10px; 
                }
                .story-content { 
                    font-size: 16px; 
                    line-height: 1.8; 
                    margin-top: 20px; 
                }
                @media print {
                    body { margin: 0; padding: 15px; }
                }
            </style>
        </head>
        <body>
            <h1>${storyTitle}</h1>
            <div class="story-content">${storyContent}</div>
            <script>window.print(); window.close();<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

async function copyStoryLink() {
    try {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Story link copied to clipboard!', 'success');
    } catch (err) {
        console.error('Failed to copy link: ', err);
        showToast('Failed to copy link', 'error');
    }
}

function confirmDelete() {
    const storyTitle = '{{ story.title|e }}';
    if (confirm(`Are you sure you want to delete "${storyTitle}"?\n\nThis action cannot be undone.`)) {
        document.getElementById('delete-form').submit();
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>

<style>
/* Constrain images in story content */
.story-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto 12px auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(25,118,210,0.08);
}
</style>
{% endblock %}
