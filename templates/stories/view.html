{% extends "layout/base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">{{ story.title }}</h4>
                    {% if story.is_published %}
                        <span class="badge bg-success mt-1">Published</span>
                    {% else %}
                        <span class="badge bg-secondary mt-1">Draft</span>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('stories.edit', id=story.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printStory()">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="story-content" id="story-content">
                    {{ story.content | replace('\n', '<br>') | safe }}
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>
                            Created {{ story.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </small>
                        {% if story.updated_at != story.created_at %}
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-pencil me-1"></i>
                            Last updated {{ story.updated_at.strftime('%B %d, %Y') }}
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('stories.index') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back to Stories
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Story Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Story Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('stories.edit', id=story.id) }}" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Edit Story
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="copyStoryLink()">
                        <i class="bi bi-link-45deg me-2"></i>Copy Link
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printStory()">
                        <i class="bi bi-printer me-2"></i>Print Story
                    </button>
                    <hr>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-2"></i>Delete Story
                    </button>
                </div>
                
                <!-- Hidden delete form -->
                <form id="delete-form" action="{{ url_for('stories.delete', id=story.id) }}" method="GET" style="display: none;">
                </form>
            </div>
        </div>
        
        <!-- Story Stats -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>Story Information
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <strong>Word Count:</strong>
                        <span id="word-count">{{ story.content.split()|length }}</span> words
                    </li>
                    <li class="mb-2">
                        <strong>Character Count:</strong>
                        <span id="char-count">{{ story.content|length }}</span> characters
                    </li>
                    <li class="mb-2">
                        <strong>Reading Time:</strong>
                        <span id="reading-time">~{{ ((story.content.split()|length / 200) * 60)|round|int }} seconds</span>
                    </li>
                    <li class="mb-2">
                        <strong>Status:</strong>
                        {% if story.is_published %}
                            <span class="text-success">Published</span>
                        {% else %}
                            <span class="text-muted">Draft</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function printStory() {
    const printWindow = window.open('', '_blank');
    const storyTitle = '{{ story.title|e }}';
    const storyContent = document.getElementById('story-content').innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${storyTitle}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    line-height: 1.6; 
                    max-width: 800px; 
                    margin: 0 auto; 
                    padding: 20px; 
                }
                h1 { 
                    border-bottom: 2px solid #333; 
                    padding-bottom: 10px; 
                }
                .story-content { 
                    font-size: 16px; 
                    line-height: 1.8; 
                    margin-top: 20px; 
                }
                @media print {
                    body { margin: 0; padding: 15px; }
                }
            </style>
        </head>
        <body>
            <h1>${storyTitle}</h1>
            <div class="story-content">${storyContent}</div>
            <script>window.print(); window.close();</script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

async function copyStoryLink() {
    try {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Story link copied to clipboard!', 'success');
    } catch (err) {
        console.error('Failed to copy link: ', err);
        showToast('Failed to copy link', 'error');
    }
}

function confirmDelete() {
    const storyTitle = '{{ story.title|e }}';
    if (confirm(`Are you sure you want to delete "${storyTitle}"?\n\nThis action cannot be undone.`)) {
        document.getElementById('delete-form').submit();
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}