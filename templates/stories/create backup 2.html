{% extends "layout/base.html" %}

{% block content %}
<div class="container py-4">


    <h2 class="mb-3" id="editor-header">
        Create Your Social Story
    </h2>

    <script>
    // Dynamically set header icon for context relevance
    document.addEventListener('DOMContentLoaded', function() {
            // --- Navigation button handlers ---
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (typeof window.showPage === 'function' && typeof window.currentPageIndex === 'number') {
                        window.showPage(window.currentPageIndex - 1, 'prev');
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (typeof window.showPage === 'function' && typeof window.currentPageIndex === 'number') {
                        window.showPage(window.currentPageIndex + 1, 'next');
                    }
                });
            }
            // --- Font Family and Size ---
            const fontFamilySelect = document.getElementById('font-family');
            const fontSizeSelect = document.getElementById('font-size');
            function applyFontFamily() {
                if (!window.pages || typeof window.currentPageIndex !== 'number') return;
                const page = window.pages[window.currentPageIndex];
                if (!page) return;
                const pageBody = page.querySelector('.page-body');
                if (pageBody && fontFamilySelect) {
                    pageBody.style.fontFamily = fontFamilySelect.value;
                }
            }
            function applyFontSize() {
                if (!window.pages || typeof window.currentPageIndex !== 'number') return;
                const page = window.pages[window.currentPageIndex];
                if (!page) return;
                const pageBody = page.querySelector('.page-body');
                if (pageBody && fontSizeSelect) {
                    // font-size uses pt mapping
                    const ptMap = { '1': '8pt', '2': '10pt', '3': '12pt', '4': '14pt', '5': '18pt', '6': '24pt', '7': '36pt' };
                    pageBody.style.fontSize = ptMap[fontSizeSelect.value] || '12pt';
                }
            }
            if (fontFamilySelect) fontFamilySelect.addEventListener('change', applyFontFamily);
            if (fontSizeSelect) fontSizeSelect.addEventListener('change', applyFontSize);
            // Apply on page change
            const origShowPage = window.showPage;
            window.showPage = function(index, direction = 'next') {
                if (!window.pages || index < 0 || index >= window.pages.length) return;
                window.pages.forEach(p => { p.style.display = 'none'; p.classList.remove('active', 'flip-3d-right', 'flip-3d-left'); });
                const page = window.pages[index];
                if (page) {
                    page.style.display = 'block';
                    page.classList.add('active');
                    // Apply font family and size to new page
                    applyFontFamily();
                    applyFontSize();
                }
                window.currentPageIndex = index;
                if (typeof window.updatePageControls === 'function') window.updatePageControls();
            };
        const headerIcon = document.getElementById('editor-header-icon');
        // If editing a story with a cover image
        if (window.storyContent && Array.isArray(window.storyContent) && window.storyContent.length > 0) {
            // Try to find a cover image from first page images
            let coverImg = null;
            if (window.storyContent[0].images && window.storyContent[0].images.length > 0) {
                coverImg = window.storyContent[0].images[0].src;
            }
            if (coverImg) {
                headerIcon.src = coverImg;
                headerIcon.alt = 'Story Cover Image';
            }
        } else {
            // If using a template, show template icon if available
            function getQueryParam(name) {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            }
            const templateImgs = getQueryParam('template_imgs');
            if (templateImgs) {
                const imgs = templateImgs.split('|~|');
                if (imgs.length > 0 && imgs[0].trim() !== '') {
                    headerIcon.src = imgs[0];
                    headerIcon.alt = 'Template Icon';
                }
            }
        }
        // Otherwise, keep default logo
    });
    </script>

    <form method="POST" enctype="multipart/form-data" id="story-form" novalidate autocomplete="off">
        {{ form.hidden_tag() }}
        <input type="hidden" id="story-content-hidden" name="content">
        <!-- Move storyContent assignment outside <script> for valid JS -->
        {% set story_content = story_content if story_content is defined else (story.content if story is defined and story.content is defined else None) %}
        <span id="story-content-json" data-story-content='{{ story_content|tojson|safe if story_content else 'null' }}' style="display:none;"></span>
        <script>
        function loadStoryContent() {
            var storyContentSpan = document.getElementById('story-content-json');
            if (!storyContentSpan) return;
            var data = storyContentSpan.getAttribute('data-story-content');
            if (!data || data === 'null') return;
            var parsed;
            try {
                parsed = JSON.parse(data);
            } catch (e) { return; }
            if (Array.isArray(parsed) && typeof window.deserializeBook === 'function') {
                window.deserializeBook(JSON.stringify(parsed));
            }
        }
        document.addEventListener('DOMContentLoaded', loadStoryContent);
        </script>
        <script>
        // --- Ensure story content is serialized before submit ---
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('story-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    // Always update hidden input with full array of pages
                    if (typeof window.serializeBook === 'function') {
                        const serialized = window.serializeBook();
                        document.getElementById('story-content-hidden').value = serialized;
                    }
                });
            }
            // --- Assign storyContent from hidden span for robust JS ---
            window.storyContent = null;
            const storyContentSpan = document.getElementById('story-content-json');
            if (storyContentSpan) {
                try {
                    let data = storyContentSpan.getAttribute('data-story-content');
                    if (data && data !== 'null') {
                        window.storyContent = JSON.parse(data);
                    } else {
                        window.storyContent = null;
                    }
                } catch (e) { window.storyContent = null; }
            }
            // --- Always start with one page if none exist ---
            window.pages = window.pages && Array.isArray(window.pages) ? window.pages : [];
            window.bookContainer = window.bookContainer || document.getElementById('book-page-container');
            if (window.pages.length === 0 && window.bookContainer) {
                if (typeof window.createPage === 'function') {
                    const page = window.createPage();
                    window.pages.push(page);
                    window.bookContainer.appendChild(page);
                    page.classList.add('active');
                    window.currentPageIndex = 0;
                }
            }
            // --- Add Page button handler (robust) ---
            const btnAddPage = document.getElementById('btn-add-page');
            if (btnAddPage) {
                btnAddPage.addEventListener('click', function() {
                    if (typeof window.createPage === 'function' && window.bookContainer && Array.isArray(window.pages)) {
                        const page = window.createPage();
                        // Ensure correct size/orientation
                        if (typeof window.applyPageSizeOrientation === 'function') {
                            window.applyPageSizeOrientation(page);
                        }
                        window.pages.push(page);
                        window.bookContainer.appendChild(page);
                        // Show the new page
                        if (typeof window.showPage === 'function') {
                            window.showPage(window.pages.length - 1, 'next');
                        }
                        // Update navigation controls
                        if (typeof window.updatePageControls === 'function') {
                            window.updatePageControls();
                        }
                        if (typeof window.saveState === 'function') {
                            window.saveState();
                        }
                    }
                });
            }
            // --- Always load all pages on edit ---
            if (window.storyContent && Array.isArray(window.storyContent) && typeof window.deserializeBook === 'function') {
                window.deserializeBook(JSON.stringify(window.storyContent));
            }
        // --- Ensure only one page is visible at a time ---
        window.showPage = function(index, direction = 'next') {
            if (!window.pages || index < 0 || index >= window.pages.length) return;
            window.pages.forEach(p => { p.style.display = 'none'; p.classList.remove('active', 'flip-3d-right', 'flip-3d-left'); });
            const page = window.pages[index];
            if (page) {
                page.style.display = 'block';
                page.classList.add('active');
            }
            window.currentPageIndex = index;
            // Enable/disable navigation buttons
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            if (prevBtn) prevBtn.disabled = (index <= 0);
            if (nextBtn) nextBtn.disabled = (index >= window.pages.length - 1);
            if (typeof window.updatePageControls === 'function') window.updatePageControls();
        };

        // --- Auto page overflow handling ---
        function autoSplitOverflow(page) {
            if (!page) return;
            const pageBody = page.querySelector('.page-body');
            if (!pageBody) return;
            // Only split if overflow detected
            if (pageBody.scrollHeight > pageBody.clientHeight + 8) {
                // Find split point in text
                let text = pageBody.innerText;
                let splitIdx = Math.floor(text.length * (pageBody.clientHeight / pageBody.scrollHeight));
                // Try to split at nearest space before splitIdx
                let safeIdx = text.lastIndexOf(' ', splitIdx);
                if (safeIdx < 20) safeIdx = splitIdx; // fallback
                let firstText = text.slice(0, safeIdx).trim();
                let overflowText = text.slice(safeIdx).trim();
                // Move overflow text to new page
                pageBody.innerText = firstText;
                const newPage = window.createPage();
                newPage.querySelector('.page-body').innerText = overflowText;
                // Move overflowing images if any
                const images = Array.from(page.querySelectorAll('.resizable'));
                images.forEach(img => {
                    const imgBottom = img.offsetTop + img.offsetHeight;
                    if (imgBottom > pageBody.clientHeight) {
                        newPage.appendChild(img);
                    }
                });
                window.pages.splice(window.pages.indexOf(page) + 1, 0, newPage);
                window.bookContainer.appendChild(newPage);
                if (typeof window.saveState === 'function') window.saveState();
            }
        }
        // Monitor page edits for overflow
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(() => {
                if (window.pages && window.pages.length > 0) {
                    window.pages.forEach(page => autoSplitOverflow(page));
                }
            }, 1000); // check every second
        });
            // --- Add SerpAPI Google Image Search UI ---
            const serpapiImageDiv = document.createElement('div');
            serpapiImageDiv.className = 'mb-3';
            serpapiImageDiv.innerHTML = `
                <label for="serpapi-image-search" class="form-label">Search Google Images to add to your story:</label>
                <div class="input-group">
                    <input type="text" id="serpapi-image-search" class="form-control" placeholder="Search Google Images..." autocomplete="off">
                    <button type="button" class="btn btn-outline-primary" id="serpapi-image-search-btn">Search</button>
                </div>
                <div id="serpapi-images" class="mt-3" style="overflow-x:auto; white-space:nowrap; display:flex; gap:12px;"></div>
            `;
            const toolbar = document.getElementById('toolbar');
            if (toolbar) toolbar.parentNode.insertBefore(serpapiImageDiv, toolbar.nextSibling);
            document.getElementById('serpapi-image-search-btn').addEventListener('click', function() {
                const query = document.getElementById('serpapi-image-search').value.trim();
                if (!query) return;
                const imagesDiv = document.getElementById('serpapi-images');
                imagesDiv.innerHTML = '<div class="text-muted">Searching Google Images...';
                fetch(`/api/serpapi_image_search?query=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        imagesDiv.innerHTML = '';
                        if (data.images && data.images.length > 0) {
                            data.images.forEach(imgUrl => {
                                const wrapper = document.createElement('div');
                                wrapper.style.display = 'inline-block';
                                wrapper.style.position = 'relative';
                                wrapper.style.marginRight = '8px';
                                const img = document.createElement('img');
                                img.src = imgUrl;
                                img.className = 'rounded shadow';
                                img.alt = 'Google Image';
                                img.style.width = '180px';
                                img.style.height = '120px';
                                img.style.objectFit = 'cover';
                                const btn = document.createElement('button');
                                btn.className = 'btn btn-sm btn-primary';
                                btn.type = 'button';
                                btn.style.position = 'absolute';
                                btn.style.bottom = '6px';
                                btn.style.left = '50%';
                                btn.style.transform = 'translateX(-50%)';
                                btn.style.display = 'flex';
                                btn.style.alignItems = 'center';
                                btn.innerHTML = '<i class="bi bi-book me-1"></i> Add image to story';
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (!window.pages || window.pages.length === 0) {
                                        alert('No pages available to add the image. Please add a page first.');
                                        return;
                                    }
                                    if (typeof window.currentPageIndex !== 'number' || window.currentPageIndex < 0 || window.currentPageIndex >= window.pages.length) {
                                        window.currentPageIndex = 0;
                                    }
                                    if (typeof window.addImageToPage === 'function') {
                                        window.addImageToPage(imgUrl);
                                    } else {
                                        alert('Image add function not available.');
                                    }
                                });
                                wrapper.appendChild(img);
                                wrapper.appendChild(btn);
                                imagesDiv.appendChild(wrapper);
                            });
                        } else {
                            imagesDiv.innerHTML = '<div class="text-danger">No images found for this search.</div>';
                        }
                    })
                    .catch(() => {
                        imagesDiv.innerHTML = '<div class="text-danger">Error searching Google Images.</div>';
                    });
            });
        });
        // --- Assign storyContent from hidden span for robust JS ---
        window.storyContent = null;
        const storyContentSpan = document.getElementById('story-content-json');
        if (storyContentSpan) {
            try {
                let data = storyContentSpan.getAttribute('data-story-content');
                if (data && data !== 'null') {
                    // Always parse as JSON if it's a string
                    window.storyContent = JSON.parse(data);
                } else {
                    window.storyContent = null;
                }
            } catch (e) { window.storyContent = null; }
        }
        </script>

        <div class="mb-3">
            {{ form.title.label(class="form-label") }}
            {{ form.title(class="form-control", id="title", placeholder="My Social Story Title") }}
        </div>
        <script>
        // --- Template loader for use_template route (with images, robust) ---
        (function() {
            function getQueryParam(name) {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            }
            const templateId = getQueryParam('template_id');
            const templateName = getQueryParam('template_name');
            const templateDesc = getQueryParam('template_desc');
            const templatePages = getQueryParam('template_pages');
            const templateImgs = getQueryParam('template_imgs');
            if (templateId && templatePages) {
                // Set title if empty
                const titleInput = document.getElementById('title');
                if (titleInput && (!titleInput.value || titleInput.value.trim() === '')) {
                    titleInput.value = templateName || '';
                }
                // Wait for DOM and editor JS to be ready
                function tryLoadTemplate(retries) {
                    if (typeof window.pages === 'undefined' || typeof window.createPage !== 'function' || typeof window.addImageToPage !== 'function') {
                        if (retries > 0) return setTimeout(() => tryLoadTemplate(retries - 1), 100);
                        return;
                    }
                    // Clear existing pages
                    while (window.pages.length > 0) {
                        const p = window.pages.pop();
                        if (p.parentNode) p.parentNode.removeChild(p);
                    }
                    // Add template pages with images
                    const pageTexts = templatePages.split('|~|');
                    const pageImgs = templateImgs ? templateImgs.split('|~|') : [];
                    pageTexts.forEach((txt, idx) => {
                        const page = window.createPage();
                        const pageBody = page.querySelector('.page-body');
                        if (pageBody) pageBody.innerText = txt;
                        window.pages.push(page);
                        window.bookContainer.appendChild(page);
                    });
                    // Now add images to correct pages
                    pageImgs.forEach((imgUrl, idx) => {
                        if (imgUrl && imgUrl.trim() !== '' && window.pages[idx]) {
                            window.currentPageIndex = idx;
                            window.addImageToPage(imgUrl);
                        }
                    });
                    // Show first page
                    if (window.pages.length > 0) {
                        window.pages.forEach(p => p.classList.remove('active'));
                        window.pages[0].classList.add('active');
                        window.currentPageIndex = 0;
                    }
                    if (typeof window.updatePageControls === 'function') window.updatePageControls();
                    if (typeof window.saveState === 'function') window.saveState();
                }
                window.addEventListener('DOMContentLoaded', function() {
                    tryLoadTemplate(20); // Try for up to 2 seconds
                });
            }
        })();
        </script>

        <!-- Google Maps Street View Search -->
        <div class="mb-3">
            <label for="maps-search" class="form-label">Search for a place or address to add Street View images:</label>
            <div class="input-group">
                <input type="text" id="maps-search" class="form-control" placeholder="Enter address or place" autocomplete="off">
                <button type="button" class="btn btn-outline-primary" id="maps-search-btn">Search</button>
            </div>
            <div id="maps-images" class="mt-3" style="overflow-x:auto; white-space:nowrap; display:flex; gap:12px;"></div>
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="custom-toolbar">
            <!-- Templates UI -->
            <div id="template-toolbar" style="width:100%;margin-bottom:16px;background:#f8f9fa;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(25,118,210,0.08);">
                <h5 style="margin-bottom:8px;color:#1976d2;"><i class="bi bi-layout-text-window me-1"></i> Story Templates</h5>
                <div class="d-flex gap-3 flex-wrap" id="template-list">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
            <!-- Page Controls -->
            <div>
                <button type="button" class="btn btn-outline-success btn-sm" id="btn-add-page" title="Add Page">+ Add Page</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="btn-remove-page" title="Remove Current Page">âˆ’ Remove Page</button>
            </div>

            <!-- Image Upload -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCg__vEXmZNhrmTCQhJqDgpUkf0nzzo3MM&libraries=places"></script>
    <script>
    // Google Maps Autocomplete, Street View, and Image Gallery
    let autocomplete;
    let selectedPlace = null;
    function initAutocomplete() {
        const input = document.getElementById('maps-search');
        autocomplete = new google.maps.places.Autocomplete(input, { types: ['geocode', 'establishment'] });
        autocomplete.addListener('place_changed', function() {
            selectedPlace = autocomplete.getPlace();
            if (selectedPlace && selectedPlace.formatted_address) {
                input.value = selectedPlace.formatted_address;
                searchMaps(selectedPlace);
            }
        });
    }
    function searchMaps(placeObj) {
        const imagesDiv = document.getElementById('maps-images');
        imagesDiv.innerHTML = '';
        let place = placeObj;
        const query = document.getElementById('maps-search').value;
        const service = new google.maps.places.PlacesService(document.createElement('div'));
        function fetchAndShowDetails(placeId, fallbackPlace) {
            service.getDetails({ placeId, fields: ['geometry','photos','name','formatted_address'] }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                    showPlaceImages(details);
                } else if (fallbackPlace) {
                    showPlaceImages(fallbackPlace);
                } else {
                    imagesDiv.innerHTML = '<div class="text-danger">No results found.</div>';
                }
            });
        }
        if (!place || !place.geometry) {
            if (!query) return;
            service.textSearch({ query }, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const result = results[0];
                    if (result.place_id) {
                        fetchAndShowDetails(result.place_id, result);
                    } else {
                        showPlaceImages(result);
                    }
                } else {
                    imagesDiv.innerHTML = '<div class="text-danger">No results found.</div>';
                }
            });
        } else if (place.place_id) {
            fetchAndShowDetails(place.place_id, place);
        } else {
            showPlaceImages(place);
        }
    }
    function showPlaceImages(place) {
        const imagesDiv = document.getElementById('maps-images');
        imagesDiv.innerHTML = '';
        function addImageWithButton(imgSrc, altText) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'inline-block';
            wrapper.style.position = 'relative';
            wrapper.style.marginRight = '8px';
            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'rounded shadow';
            img.alt = altText;
            img.style.width = '180px';
            img.style.height = '120px';
            img.style.objectFit = 'cover';
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-primary';
            btn.type = 'button';
            btn.style.position = 'absolute';
            btn.style.bottom = '6px';
            btn.style.left = '50%';
            btn.style.transform = 'translateX(-50%)';
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.innerHTML = '<i class="bi bi-book me-1"></i> Add image to story';
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Ensure a valid page is selected
                if (!window.pages || window.pages.length === 0) {
                    alert('No pages available to add the image. Please add a page first.');
                    return;
                }
                if (typeof window.currentPageIndex !== 'number' || window.currentPageIndex < 0 || window.currentPageIndex >= window.pages.length) {
                    window.currentPageIndex = 0;
                }
                if (typeof window.addImageToPage === 'function') {
                    window.addImageToPage(imgSrc);
                } else {
                    alert('Image add function not available.');
                }
            });
            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            imagesDiv.appendChild(wrapper);
        }
        // Street View (robust for both PlaceResult and text search)
        let lat = null, lng = null;
        if (place.geometry && place.geometry.location) {
            if (typeof place.geometry.location.lat === 'function') {
                lat = place.geometry.location.lat();
                lng = place.geometry.location.lng();
            } else {
                lat = place.geometry.location.lat;
                lng = place.geometry.location.lng;
            }
        } else if (place.lat && place.lng) {
            lat = place.lat;
            lng = place.lng;
        }
        if (lat !== null && lng !== null) {
            const svImgSrc = `https://maps.googleapis.com/maps/api/streetview?size=400x200&location=${lat},${lng}&key=AIzaSyCg__vEXmZNhrmTCQhJqDgpUkf0nzzo3MM`;
            addImageWithButton(svImgSrc, 'Street View');
        }
        // Place Photos (show all available, scrollable)
        if (place.photos && place.photos.length > 0) {
            place.photos.forEach(photo => {
                const imgSrc = photo.getUrl({maxWidth:400, maxHeight:200});
                addImageWithButton(imgSrc, 'Place Photo');
            });
        }
        if (imagesDiv.children.length === 0) {
            imagesDiv.innerHTML = '<div class="text-danger">No images found for this place.</div>';
        }
    }
    document.getElementById('maps-search-btn').addEventListener('click', function() {
        if (selectedPlace) {
            searchMaps(selectedPlace);
        } else {
            searchMaps(null);
        }
    });
    document.getElementById('maps-search').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedPlace) {
                searchMaps(selectedPlace);
            } else {
                searchMaps(null);
            }
        }
    });
    window.addEventListener('DOMContentLoaded', function() {
        if (typeof google !== 'undefined' && google.maps && google.maps.places) {
            initAutocomplete();
        } else {
            // fallback: try again after a short delay
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.maps && google.maps.places) initAutocomplete();
            }, 1000);
        }
    });
    </script>
<!-- Gemini Floating Chat Bubble -->
<div id="gemini-chat-bubble" style="position:fixed;bottom:32px;right:32px;z-index:9999;">
    <button id="gemini-chat-toggle" class="btn btn-primary rounded-circle shadow" style="width:70px;height:70px;display:flex;align-items:center;justify-content:center;">
        <img src="/static/img/AI_assistant.png" alt="AI" class="primary rounded-circle shadow" style="width:66px;height:66px;">
    </button>
    <div id="gemini-chat-popup" style="display:none;position:absolute;bottom:70px;right:0;width:340px;background:#e3f2fd;border-radius:16px;box-shadow:0 4px 24px rgba(25,118,210,0.18);padding:16px;">
        <div style="font-weight:600;color:#1976d2;margin-bottom:8px;"><i class="bi bi-stars"></i> Gemini AI Assistant</div>
        <div id="gemini-chat-window" style="max-height:180px;overflow-y:auto;background:#fff;border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid #b3c2d6;"></div>
        <button type="button" id="gemini-copy-btn" class="btn btn-outline-secondary btn-sm mb-2" style="width:100%;">Copy Gemini Text</button>
        <div id="gemini-loading-bar" style="display:none;margin-bottom:8px;">
            <div class="progress" style="height:8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:100%;background:#1976d2;"></div>
            </div>
            <div class="text-center small text-muted mt-1">Generating...</div>
        </div>
        <div class="input-group">
            <input type="text" id="gemini-chat-input" class="form-control" placeholder="Ask Gemini to generate text or images...">
            <button type="button" id="gemini-chat-send" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

            <div>
                <label class="btn btn-outline-primary btn-sm mb-0" for="globalImageInput" title="Upload Images">
                    <i class="bi bi-image me-1"></i> Choose File
                </label>
                <input type="file" id="globalImageInput" accept="image/*" hidden multiple>
            </div>

            <!-- Text Formatting Buttons -->
            <div class="btn-group btn-group-sm" role="group" aria-label="Basic formatting">
                <button type="button" class="btn btn-outline-secondary" data-cmd="bold" title="Bold"><strong>B</strong></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="italic" title="Italic"><em>I</em></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="underline" title="Underline"><u>U</u></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Text alignment">
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyLeft" title="Align Left"><i class="bi bi-text-left"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyCenter" title="Align Center"><i class="bi bi-text-center"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyRight" title="Align Right"><i class="bi bi-text-right"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="justifyFull" title="Justify"><i class="bi bi-justify"></i></button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Lists">
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertUnorderedList" title="Bullet List"><i class="bi bi-list-ul"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertOrderedList" title="Numbered List"><i class="bi bi-list-ol"></i></button>
            </div>

            <!-- Font Family -->
            <select id="font-family" class="form-select form-select-sm w-auto" title="Font Family" aria-label="Font Family Selector">
                <option value="Arial" selected>Arial</option>
                <option value="Courier New">Courier New</option>
                <option value="Georgia">Georgia</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Verdana">Verdana</option>
            </select>

            <!-- Font Size -->
            <select id="font-size" class="form-select form-select-sm w-auto" title="Font Size" aria-label="Font Size Selector">
                <option value="1">8pt</option>
                <option value="2">10pt</option>
                <option value="3" selected>12pt</option>
                <option value="4">14pt</option>
                <option value="5">18pt</option>
                <option value="6">24pt</option>
                <option value="7">36pt</option>
            </select>

            <!-- Text Color -->
            <input type="color" id="fore-color" class="form-control form-control-color w-auto" title="Text Color" aria-label="Text Color Picker" value="#000000" style="height:34px;">

            <!-- Highlight Color -->
            <input type="color" id="hilite-color" class="form-control form-control-color w-auto" title="Highlight Color" aria-label="Highlight Color Picker" value="#ffff00" style="height:34px;">

            <!-- Undo / Redo -->
            <div class="btn-group btn-group-sm ms-auto" role="group" aria-label="Undo / Redo">
                <button type="button" class="btn btn-outline-secondary" id="undo" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="redo" title="Redo"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>

        <!-- Page Customization -->
        <div class="d-flex gap-3 align-items-center mb-3">
            <button type="button" id="remove-bg-image" class="btn btn-outline-danger btn-sm ms-2">Remove Background Image</button>
            <label for="page-bg-color" class="mb-0">Page Background Color:</label>
            <input type="color" id="page-bg-color" value="#ffffff" title="Change Page Background Color">

            <label for="page-bg-image" class="mb-0">Page Background Image:</label>
            <input type="file" id="page-bg-image" accept="image/*" title="Upload Page Background Image">

            <label for="page-size" class="mb-0">Page Size:</label>
            <select id="page-size" class="form-select form-select-sm w-auto" title="Select Page Size">
                <option value="A5" selected>A5 (148x210 mm)</option>
                <option value="A4">A4 (210x297 mm)</option>
                <option value="Letter">Letter (8.5x11 in)</option>
            </select>

            <label for="page-orientation" class="mb-0">Orientation:</label>
            <select id="page-orientation" class="form-select form-select-sm w-auto" title="Select Page Orientation">
                <option value="portrait" selected>Portrait</option>
                <option value="landscape">Landscape</option>
            </select>
        </div>

        <!-- Book Container -->
        <div id="book-wrapper" class="position-relative mx-auto" tabindex="0" style="outline:none;">
            <div id="book-page-container" class="book-page-flip" aria-live="polite" aria-atomic="true" aria-relevant="additions removals" style="display:flex; justify-content:center; align-items:center; position:relative;">
                <!-- Pages inserted here dynamically -->
                <div class="book-crease"></div>
            </div>
            <button type="button" id="prev-page" class="btn btn-outline-secondary" style="position:absolute; left:10px; top:50%; transform:translateY(-50%);" aria-label="Previous Page">&larr;</button>
            <button type="button" id="next-page" class="btn btn-outline-secondary" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);" aria-label="Next Page">&rarr;</button>
        </div>

        <div class="form-check mt-4">
            {{ form.is_published(class="form-check-input") }}
            {{ form.is_published.label(class="form-check-label") }}
        </div>

        <div class="d-flex gap-2 mt-3">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('stories.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Stories
            </a>
            <button type="button" class="btn btn-outline-info" id="preview-button">
                <i class="bi bi-eye me-1"></i>Preview
            </button>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Storybook Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="previewModalBody"></div>
                <div id="preview-content" class="d-flex flex-wrap justify-content-center gap-4 p-3" style="background:#e7e9ed; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
/* Custom toolbar styling */
.custom-toolbar {
    background: #f5f7fa;
    border: 2px solid #1976d2;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 32px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
}

.btn-outline-secondary {
    border-color: #1976d2;
    color: #1976d2;
    background: #fff;
}
.btn-outline-secondary.active, .btn-outline-secondary:active, .btn-outline-secondary:focus {
    background: #1976d2;
    color: #fff;
    border-color: #1976d2;
}
.btn-outline-success {
    background: #43a047;
    color: #fff;
    border-color: #43a047;
}
.btn-outline-danger {
    background: #e53935;
    color: #fff;
    border-color: #e53935;
}
.btn-outline-primary {
    background: #1976d2;
    color: #fff;
    border-color: #1976d2;
}
/* --- Book Container & Pages --- */
#book-wrapper {
    width: auto;
    min-width: 0;
    max-width: none;
    min-height: 0;
    margin: 40px auto 0 auto;
    position: relative;
    overflow: visible;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    user-select: none;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#book-page-container {
    min-height: 460px;
    position: relative;
    perspective: 1600px;
    overflow: visible;
    display: flex;
    justify-content: center;
    align-items: center;
}

.book-page {
    width: 48%;
    min-width: 320px;
    max-width: 480px;
    height: 100%;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 14px;
    padding: 16px;
    box-shadow:
        inset 0 0 10px #fafafa,
        0 6px 12px rgba(0,0,0,0.1);
    position: absolute;
    top: 0;
    left: 0;
    transform-style: preserve-3d;
    backface-visibility: hidden;
    transition: box-shadow 0.3s ease;
    z-index: 1;
    display: none;
    overflow: auto;
}

.book-page.active {
    display: block;
    z-index: 5;
    transform: rotateY(0deg);
    box-shadow:
        inset 0 0 18px #fff,
        0 14px 24px rgba(0,0,0,0.25);
    user-select: text;
    position: relative;
}

/* Page flipping animation */

.book-page.animate-flip-next {
    animation: pageFlipNext 0.8s forwards;
    transform-origin: left center;
    z-index: 10 !important;
}

.book-page.animate-flip-prev {
    animation: pageFlipPrev 0.8s forwards;
    transform-origin: right center;
    z-index: 10 !important;
}

@keyframes pageFlipNext {
    0% {
        transform: rotateY(0deg);
        box-shadow: 0 14px 24px rgba(0,0,0,0.25);
    }
    50% {
        transform: rotateY(-90deg);
        box-shadow: 0 0 40px rgba(0,0,0,0.4);
    }
    100% {
        transform: rotateY(-180deg);
        box-shadow: 0 0 0 transparent;
        visibility: hidden;
    }
}

@keyframes pageFlipPrev {
    0% {
        transform: rotateY(0deg);
        box-shadow: 0 14px 24px rgba(0,0,0,0.25);
    }
    50% {
        transform: rotateY(90deg);
        box-shadow: 0 0 40px rgba(0,0,0,0.4);
    }
    100% {
        transform: rotateY(180deg);
        box-shadow: 0 0 0 transparent;
        visibility: hidden;
    }
}

/* Page body text */
.page-body {
    width: 100%;
    height: 100%;
    outline: none;
    font-size: 1.1rem;
    line-height: 1.5;
    color: #333;
    background: transparent;
    border-radius: 8px;
    padding: 10px 14px;
    overflow-y: auto;
    user-select: text;
    white-space: pre-wrap;
    font-family: inherit;
}

/* Resizable images */
.resizable {
    position: absolute;
    border: 2px solid #bbb;
    background: #fff;
    border-radius: 6px;
    overflow: hidden;
    cursor: move;
    user-select: none;
    z-index: 20;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

/* Image styling */
.resizable img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
}

/* Image controls container */
.image-controls {
    position: absolute;
    bottom: -36px;
    left: 0;
    display: flex;
    gap: 6px;
    user-select: none;
}

/* Control buttons */
.image-controls button {
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #f7f7f7;
    color: #333;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.image-controls button:hover {
    background-color: #ddd;
}

/* Remove image button (fixed position to avoid cutoff) */
.remove-btn {
    position: absolute;
    top: -14px;
    right: -14px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    line-height: 28px;
    padding: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 25;
}

/* Navigation buttons */
#prev-page, #next-page {
    width: 38px;
    height: 48px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.85;
    transition: opacity 0.3s ease;
    font-weight: 700;
    font-size: 1.5rem;
    user-select: none;
    z-index: 50;
}

#prev-page:hover, #next-page:hover {
    opacity: 1;
}

#prev-page {
    left: -48px;
}

#next-page {
    right: -48px;
}

/* Preview styling */
#preview-content {
    min-height: 100px;
}

#preview-content .book-page {
    position: relative !important;
    width: 320px !important;
    height: 460px !important;
    margin-bottom: 20px;
    box-shadow:
        0 8px 16px rgba(0,0,0,0.25);
    border: 2px solid #bbb !important;
    border-radius: 12px !important;
    transform: none !important;
    display: block !important;
    user-select: none;
}

/* Preview page body text */
#preview-content .page-body {
    outline: none;
    cursor: default;
    user-select: text;
}

/* Drag-and-drop preview page style */
.draggable-preview-page {
    cursor: grab;
}

.draggable-preview-page:active {
    cursor: grabbing;
}

/* Remove file chosen text */
label[for="globalImageInput"] {
    cursor: pointer;
    user-select: none;
}

label[for="globalImageInput"]::after {
    content: "";
}

/* Scrollbar styling for contenteditable */
.page-body::-webkit-scrollbar {
    width: 8px;
}
.page-body::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}
.page-body::-webkit-scrollbar-track {
    background: #f9f9f9;
}

/* Active formatting buttons highlight */
.btn-outline-secondary.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

/* Add CSS for 3D single page flip animation */
.book-page.flip-3d-right {
    animation: flip3dRight 0.5s cubic-bezier(0.4,0.2,0.2,1);
    transform-origin: left center;
}
.book-page.flip-3d-left {
    animation: flip3dLeft 0.5s cubic-bezier(0.4,0.2,0.2,1);
    transform-origin: right center;
}
@keyframes flip3dRight {
    0% { transform: perspective(600px) rotateY(0deg); }
    100% { transform: perspective(600px) rotateY(-120deg); opacity: 0.5; }
}
@keyframes flip3dLeft {
    0% { transform: perspective(600px) rotateY(0deg); }
    100% { transform: perspective(600px) rotateY(120deg); opacity: 0.5; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
(() => {
    // Gemini loading bar logic
    const geminiLoadingBar = document.getElementById('gemini-loading-bar');
    const geminiSendBtn = document.getElementById('gemini-chat-send');
    const geminiInput = document.getElementById('gemini-chat-input');
    const geminiWindow = document.getElementById('gemini-chat-window');

    function setGeminiLoading(isLoading) {
        geminiLoadingBar.style.display = isLoading ? 'block' : 'none';
        geminiSendBtn.disabled = isLoading;
        geminiInput.disabled = isLoading;
    }

    // Intercept Gemini send button
    async function sendGeminiMessage() {
        const prompt = geminiInput.value.trim();
        if (!prompt) return;
        // TODO: Implement Gemini API call here
        // The code block below appears to be misplaced and should be removed or replaced with actual Gemini API logic.
        // Remove the following block to fix the syntax error:
        /*
        (function() {
            function getQueryParam(name) {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            }
            const templateId = getQueryParam('template_id');
            const templateName = getQueryParam('template_name');
            const templateDesc = getQueryParam('template_desc');
            const templatePages = getQueryParam('template_pages');
            const templateImgs = getQueryParam('template_imgs');
            if (window.storyContent) {
                // Wait for DOM and editor JS to be ready
                function tryLoadStory(retries) {
                    if (typeof window.deserializeBook !== 'function' || typeof window.createPage !== 'function') {
                        if (retries > 0) return setTimeout(() => tryLoadStory(retries - 1), 100);
                        return;
                    }
                    window.deserializeBook(JSON.stringify(window.storyContent));
                }
                window.addEventListener('DOMContentLoaded', function() {
                    tryLoadStory(20);
                });
            } else if (templateId && templatePages) {
                // Set title if empty
                const titleInput = document.getElementById('title');
                if (titleInput && (!titleInput.value || titleInput.value.trim() === '')) {
                    titleInput.value = templateName || '';
                }
                // Wait for DOM and editor JS to be ready
                function tryLoadTemplate(retries) {
                    if (typeof window.pages === 'undefined' || typeof window.createPage !== 'function' || typeof window.addImageToPage !== 'function') {
                        if (retries > 0) return setTimeout(() => tryLoadTemplate(retries - 1), 100);
                        return;
                    }
                    // Clear existing pages
                    while (window.pages.length > 0) {
                        const p = window.pages.pop();
                        if (p.parentNode) p.parentNode.removeChild(p);
                    }
                    // Add template pages with images
                    const pageTexts = templatePages.split('|~|');
                    const pageImgs = templateImgs ? templateImgs.split('|~|') : [];
                    pageTexts.forEach((txt, idx) => {
                        const page = window.createPage();
                        const pageBody = page.querySelector('.page-body');
                        if (pageBody) pageBody.innerText = txt;
                        window.pages.push(page);
                        window.bookContainer.appendChild(page);
                    });
                    // Now add images to correct pages
                    pageImgs.forEach((imgUrl, idx) => {
                        if (imgUrl && imgUrl.trim() !== '' && window.pages[idx]) {
                            window.currentPageIndex = idx;
                            window.addImageToPage(imgUrl);
                        }
                    });
                    // Show first page
                    if (window.pages.length > 0) {
                        window.pages.forEach(p => p.classList.remove('active'));
                        window.pages[0].classList.add('active');
                        window.currentPageIndex = 0;
                    }
                    if (typeof window.updatePageControls === 'function') window.updatePageControls();
                    if (typeof window.saveState === 'function') window.saveState();
                }
                window.addEventListener('DOMContentLoaded', function() {
                    tryLoadTemplate(20); // Try for up to 2 seconds
                });
            }
        })();
        */
        // You can implement your Gemini API call here and handle the response.
    }
    // Gemini Chat Bubble Logic
    const geminiBubble = document.getElementById('gemini-chat-bubble');
    const geminiToggle = document.getElementById('gemini-chat-toggle');
    const geminiPopup = document.getElementById('gemini-chat-popup');
    geminiToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        geminiPopup.style.display = geminiPopup.style.display === 'none' ? 'block' : 'none';
    });
    // State variables
    let pages = [];
    let currentPageIndex = 0;
    let isAnimating = false;
    let undoStack = [];
    let redoStack = [];

    const bookContainer = document.getElementById('book-page-container');
    const titleInput = document.getElementById('title');
    const globalImageInput = document.getElementById('globalImageInput');
    const pageBgColorInput = document.getElementById('page-bg-color');
    const pageBgImageInput = document.getElementById('page-bg-image');
    const pageSizeSelect = document.getElementById('page-size');
    const pageOrientationSelect = document.getElementById('page-orientation');
    const previewButton = document.getElementById('preview-button');



    // Undo/Redo helper functions
    function saveState() {
        // Deep clone pages content
        const state = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        undoStack.push(state);
        if (undoStack.length > 100) undoStack.shift();
        redoStack = []; // Clear redo on new action
        updateUndoRedoButtons();
    }
    function restoreState(state) {
        pages.forEach((page, idx) => {
            if (!state[idx]) return;
            const pb = page.querySelector('.page-body');
            pb.innerHTML = state[idx].html;
            page.style.backgroundColor = state[idx].bgColor;
            page.style.backgroundImage = state[idx].bgImage;
            page.setAttribute('data-page-size', state[idx].pageSize);
            page.setAttribute('data-orientation', state[idx].orientation);
            applyPageSizeOrientation(page);
            // Remove existing images
            const existingImgs = page.querySelectorAll('.resizable');
            existingImgs.forEach(e => e.remove());
            // Add images
            state[idx].images.forEach(imgData => {
                const imgContainer = createResizableImage(imgData.src);
                imgContainer.style = imgData.style || '';
                imgContainer.style.zIndex = imgData.zIndex || '20';
                imgContainer.setAttribute('data-x', imgData.dataX);
                imgContainer.setAttribute('data-y', imgData.dataY);
                applyTransform(imgContainer, parseFloat(imgData.dataX), parseFloat(imgData.dataY));
                page.appendChild(imgContainer);
                enableInteract(imgContainer);
            });
        });
    }
    function undo() {
        if (undoStack.length === 0) return;
        const currentState = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        redoStack.push(currentState);
        const lastState = undoStack.pop();
        restoreState(lastState);
        updateUndoRedoButtons();
    }
    function redo() {
        if (redoStack.length === 0) return;
        const currentState = pages.map(p => {
            return {
                html: p.querySelector('.page-body').innerHTML,
                images: Array.from(p.querySelectorAll('.resizable')).map(imgContainer => {
                    return {
                        src: imgContainer.querySelector('img').src,
                        style: imgContainer.getAttribute('style'),
                        zIndex: imgContainer.style.zIndex || '20',
                        dataX: imgContainer.getAttribute('data-x') || '0',
                        dataY: imgContainer.getAttribute('data-y') || '0',
                    };
                }),
                bgColor: p.style.backgroundColor || '#fff',
                bgImage: p.style.backgroundImage || '',
                pageSize: p.getAttribute('data-page-size') || 'A5',
                orientation: p.getAttribute('data-orientation') || 'portrait'
            };
        });
        undoStack.push(currentState);
        const nextState = redoStack.pop();
        restoreState(nextState);
        updateUndoRedoButtons();
    }
    function updateUndoRedoButtons() {
        undoBtn.disabled = undoStack.length === 0;
        redoBtn.disabled = redoStack.length === 0;
    }

    // Create a new page element
    function createPage() {
        const page = document.createElement('div');
        page.classList.add('book-page');
        let size = pageSizeSelect ? pageSizeSelect.value : 'A5';
        let orientation = pageOrientationSelect ? pageOrientationSelect.value : 'portrait';
        page.setAttribute('data-page-size', size);
        page.setAttribute('data-orientation', orientation);
        page.style.backgroundColor = pageBgColorInput ? pageBgColorInput.value : '#fff';
        page.style.backgroundImage = '';

        const pageBody = document.createElement('div');
        pageBody.className = 'page-body';
        pageBody.contentEditable = 'true';
        pageBody.setAttribute('aria-label', 'Page content');
        pageBody.spellcheck = false;
        pageBody.style.position = 'relative';
        pageBody.style.minHeight = '100%';
        page.appendChild(pageBody);

        // No default images

        pageBody.addEventListener('input', () => saveState());
        pageBody.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'z')) {
                e.preventDefault();
                undo();
            } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y')) {
                e.preventDefault();
                redo();
            }
        });
        // No background color/image event listeners here!
    // Attach background color/image listeners ONCE, outside createPage
    if (pageBgColorInput) {
        pageBgColorInput.addEventListener('input', function() {
            if (!pages[currentPageIndex]) return;
            pages[currentPageIndex].style.backgroundColor = pageBgColorInput.value;
            saveState();
        });
    }
    if (pageBgImageInput) {
        pageBgImageInput.addEventListener('change', function() {
            if (!pages[currentPageIndex]) return;
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pages[currentPageIndex].style.backgroundImage = `url('${e.target.result}')`;
                    pages[currentPageIndex].style.backgroundSize = 'cover';
                    pages[currentPageIndex].style.backgroundPosition = 'center center';
                    saveState();
                };
                reader.readAsDataURL(file);
            }
        });
    }
    const removeBgBtn = document.getElementById('remove-bg-image');
    if (removeBgBtn) {
        removeBgBtn.addEventListener('click', function() {
            if (!pages[currentPageIndex]) return;
            pages[currentPageIndex].style.backgroundImage = '';
            saveState();
        });
    }
        return page;
    }

    // Show page by index with 3D flip animation (single page only)
    function showPage(index, direction = 'next') {
        if (isAnimating || index < 0 || index >= pages.length || index === currentPageIndex) return;
        isAnimating = true;
        pages.forEach(p => { p.style.display = 'none'; p.classList.remove('active', 'flip-3d-right', 'flip-3d-left'); });
        const page = pages[index];
        if (page) {
            page.style.display = 'block';
            page.classList.add('active');
            if (direction === 'next') page.classList.add('flip-3d-right');
            else if (direction === 'prev') page.classList.add('flip-3d-left');
            setTimeout(() => {
                page.classList.remove('flip-3d-right', 'flip-3d-left');
                isAnimating = false;
                updatePageControls();
                saveState();
            }, 500);
        }
        currentPageIndex = index;
    }

    // Update navigation button states
    function updatePageControls() {
        prevBtn.disabled = currentPageIndex === 0;
        nextBtn.disabled = currentPageIndex === pages.length - 1;
    }

    // Add image to current page
    function addImageToPage(src) {
        if (!window.pages || !window.pages.length || typeof window.currentPageIndex === 'undefined' || window.currentPageIndex === null) {
            alert('No page available to add image.');
            return;
        }
        const page = window.pages[window.currentPageIndex];
        if (!page) {
            alert('No page available to add image.');
            return;
        }
        const imgContainer = createResizableImage(src);
        page.appendChild(imgContainer);
        if (typeof enableInteract === 'function') enableInteract(imgContainer);
        if (typeof saveState === 'function') saveState();
    }

    // Create a resizable, draggable image container
    function createResizableImage(src) {
        const container = document.createElement('div');
        container.classList.add('resizable');
        container.style.width = '180px';
        container.style.height = '120px';
        container.style.top = '50px';
        container.style.left = '50px';
        container.style.position = 'absolute';
        container.style.zIndex = 20;
        container.setAttribute('data-x', '0');
        container.setAttribute('data-y', '0');

        // Text wrapping: image floats left, text wraps
        container.style.float = 'left';
        container.style.margin = '8px 16px 8px 0';

        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Inserted Image';
        img.style.pointerEvents = 'none';
        img.style.display = 'block';
        img.style.background = 'rgba(255,255,255,0.85)';
        img.style.borderRadius = '6px';
        img.style.boxShadow = '0 0 5px rgba(0,0,0,0.1)';
        container.appendChild(img);

        // Remove button (always visible, above image)
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '&times;';
        removeBtn.classList.add('remove-btn');
        removeBtn.title = 'Remove Image';
        removeBtn.style.zIndex = 100;
        removeBtn.style.position = 'absolute';
        removeBtn.style.top = '2px';
        removeBtn.style.right = '2px';
        removeBtn.style.background = '#dc3545';
        removeBtn.style.color = '#fff';
        removeBtn.style.border = 'none';
        removeBtn.style.borderRadius = '50%';
        removeBtn.style.width = '28px';
        removeBtn.style.height = '28px';
        removeBtn.style.fontSize = '18px';
        removeBtn.style.fontWeight = 'bold';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.lineHeight = '28px';
        removeBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            container.remove();
            saveState();
        });
        container.appendChild(removeBtn);

        // Layer controls container
        const controls = document.createElement('div');
        controls.className = 'image-controls';

        const bringForwardBtn = document.createElement('button');
        bringForwardBtn.title = 'Bring Forward';
        bringForwardBtn.innerHTML = '<i class="bi bi-arrow-up"></i>';
        bringForwardBtn.type = 'button';
        bringForwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            container.style.zIndex = currentZ + 1;
            saveState();
        });

        const sendBackwardBtn = document.createElement('button');
        sendBackwardBtn.title = 'Send Backward';
        sendBackwardBtn.innerHTML = '<i class="bi bi-arrow-down"></i>';
        sendBackwardBtn.type = 'button';
        sendBackwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            if (currentZ > 1) container.style.zIndex = currentZ - 1;
            saveState();
        });

        controls.appendChild(bringForwardBtn);
        controls.appendChild(sendBackwardBtn);
        container.appendChild(controls);

        return container;
    }

    // Apply CSS transform to position container
    function applyTransform(el, x, y) {
        el.style.transform = `translate(${x}px, ${y}px)`;
        el.setAttribute('data-x', x);
        el.setAttribute('data-y', y);
    }

    // Enable interact.js draggable and resizable on image containers
    function enableInteract(target) {
        interact(target)
            .draggable({
                listeners: {
                    move(event) {
                        const el = event.target;
                        let x = (parseFloat(el.getAttribute('data-x')) || 0) + event.dx;
                        let y = (parseFloat(el.getAttribute('data-y')) || 0) + event.dy;
                        applyTransform(el, x, y);
                    },
                    end(event) {
                        saveState();
                    }
                },
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: 'parent',
                        endOnly: true
                    })
                ],
                inertia: true
            })
            .resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                listeners: {
                    move(event) {
                        let width = event.rect.width;
                        let height = event.rect.height;

                        // Update the element's style
                        event.target.style.width = width + 'px';
                        event.target.style.height = height + 'px';

                        // Translate when resizing from top or left edges
                        let x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.deltaRect.left;
                        let y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.deltaRect.top;

                        applyTransform(event.target, x, y);
                    },
                    end(event) {
                        saveState();
                    }
                },
                modifiers: [
                    interact.modifiers.restrictEdges({
                        outer: 'parent',
                        endOnly: true
                    }),
                    interact.modifiers.restrictSize({
                        min: { width: 60, height: 40 },
                        max: { width: 600, height: 600 }
                    })
                ],
                inertia: true
            });
    }

    // Initialize toolbar buttons for text formatting
    const toolbar = document.getElementById('toolbar');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeSelect = document.getElementById('font-size');
    const foreColorInput = document.getElementById('fore-color');
    const hiliteColorInput = document.getElementById('hilite-color');
    const undoBtn = document.getElementById('undo');
    const redoBtn = document.getElementById('redo');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const btnAddPage = document.getElementById('btn-add-page');
    const btnRemovePage = document.getElementById('btn-remove-page');

    // Commands with execCommand fallback (execCommand deprecated but works)
    toolbar.addEventListener('click', e => {
        const btn = e.target.closest('button[data-cmd]');
        if (!btn) return;
        const cmd = btn.dataset.cmd;

        // Special handling for text alignment and lists - execCommand handles those as well
        document.execCommand(cmd, false, null);
        updateToolbarState();
        saveState();
    });

    // Font family change
    fontFamilySelect.addEventListener('change', () => {
        const activePage = pages[currentPageIndex];
        if (activePage) {
            const pageBody = activePage.querySelector('.page-body');
            pageBody.focus();
            document.execCommand('fontName', false, fontFamilySelect.value);
            updateToolbarState();
            saveState();
        }
    });

    // Font size change
    fontSizeSelect.addEventListener('change', () => {
        const activePage = pages[currentPageIndex];
        if (activePage) {
            const pageBody = activePage.querySelector('.page-body');
            pageBody.focus();
            document.execCommand('fontSize', false, fontSizeSelect.value);
            updateToolbarState();
            saveState();
        }
    });

    // Foreground color change
    foreColorInput.addEventListener('input', () => {
        const activePage = pages[currentPageIndex];
        if (activePage) {
            const pageBody = activePage.querySelector('.page-body');
            pageBody.focus();
            // Select current selection if not in pageBody
            if (window.getSelection) {
                const sel = window.getSelection();
                if (!sel.anchorNode || !pageBody.contains(sel.anchorNode)) {
                    const range = document.createRange();
                    range.selectNodeContents(pageBody);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
            // Try execCommand, fallback to style
            const success = document.execCommand('foreColor', false, foreColorInput.value);
            if (!success) {
                if (window.getSelection) {
                    const sel = window.getSelection();
                    if (sel.rangeCount > 0) {
                        const range = sel.getRangeAt(0);
                        const span = document.createElement('span');
                        span.style.color = foreColorInput.value;
                        range.surroundContents(span);
                    }
                }
            }
            updateToolbarState();
            saveState();
        }
    });

    // Highlight color change
    hiliteColorInput.addEventListener('input', () => {
        const activePage = pages[currentPageIndex];
        if (activePage) {
            const pageBody = activePage.querySelector('.page-body');
            pageBody.focus();
            document.execCommand('hiliteColor', false, hiliteColorInput.value);
            updateToolbarState();
            saveState();
        }
    });

    // Undo/Redo buttons
    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    // Update toolbar button active states
    function updateToolbarState() {
        const commands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertUnorderedList', 'insertOrderedList'];
        commands.forEach(cmd => {
            const button = toolbar.querySelector(`button[data-cmd="${cmd}"]`);
            if (!button) return;
            if (document.queryCommandState(cmd)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // Update on selection change
    document.addEventListener('selectionchange', () => {
        updateToolbarState();
    });

    // Add page
    btnAddPage.addEventListener('click', () => {
        const page = createPage();
        pages.push(page);
        bookContainer.appendChild(page);
        applyPageSizeOrientation(page);
        currentPageIndex = pages.length - 1;
        showPage(currentPageIndex, 'next');
        updatePageControls();
        saveState();
    });

    // Remove current page
    btnRemovePage.addEventListener('click', () => {
        if (pages.length <= 1) {
            alert('Cannot remove the last page.');
            return;
        }
        pages[currentPageIndex].remove();
        pages.splice(currentPageIndex, 1);
        if (currentPageIndex >= pages.length) currentPageIndex = pages.length - 1;
        showPage(currentPageIndex, 'prev');
        saveState();
        updatePageControls();
    });

    // Prev/Next buttons
    prevBtn.addEventListener('click', () => {
        showPage(currentPageIndex - 1, 'prev');
    });

    nextBtn.addEventListener('click', () => {
        showPage(currentPageIndex + 1, 'next');
    });

    // Global image upload
    globalImageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (!files.length) return;
        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                addImageToPage(event.target.result);
            };
            reader.readAsDataURL(file);
        });
        globalImageInput.value = null;
    });

    // Page background color change
    pageBgColorInput.addEventListener('input', () => {
        if (!pages[currentPageIndex]) return;
        pages[currentPageIndex].style.backgroundColor = pageBgColorInput.value;
        // Remove bg image if color changed
        pages[currentPageIndex].style.backgroundImage = '';
        saveState();
    });

    // Page background image upload
    pageBgImageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            if (!pages[currentPageIndex]) return;
            pages[currentPageIndex].style.backgroundImage = `url('${event.target.result}')`;
            pages[currentPageIndex].style.backgroundSize = 'cover';
            pages[currentPageIndex].style.backgroundPosition = 'center center';
            saveState();
        };
        reader.readAsDataURL(file);
        pageBgImageInput.value = null;
    });

    // Page size change
    pageSizeSelect.addEventListener('change', () => {
        if (!pages[currentPageIndex]) return;
        const size = pageSizeSelect.value;
        pages[currentPageIndex].setAttribute('data-page-size', size);
        applyPageSizeOrientation(pages[currentPageIndex]);
        saveState();
    });

    // Page orientation change
    pageOrientationSelect.addEventListener('change', () => {
        if (!pages[currentPageIndex]) return;
        const orientation = pageOrientationSelect.value;
        pages[currentPageIndex].setAttribute('data-orientation', orientation);
        applyPageSizeOrientation(pages[currentPageIndex]);
        saveState();
    });

    // Page orientation and size controls
    pageSizeSelect.addEventListener('change', function() {
        // Update ALL pages to selected size
        pages.forEach(page => {
            page.setAttribute('data-page-size', pageSizeSelect.value);
            applyPageSizeOrientation(page);
        });
    });
    pageOrientationSelect.addEventListener('change', function() {
        // Update ALL pages to selected orientation
        pages.forEach(page => {
            page.setAttribute('data-orientation', pageOrientationSelect.value);
            applyPageSizeOrientation(page);
            // Force re-render by toggling display
            page.style.display = 'none';
            setTimeout(() => {
                page.style.display = '';
            }, 10);
        });
        showPage(currentPageIndex);
    });

    // --- Page size/orientation controls ---
    function applyPageSizeOrientation(page) {
        if (!page) return;
        const size = page.getAttribute('data-page-size') || (pageSizeSelect ? pageSizeSelect.value : 'A5');
        const orientation = page.getAttribute('data-orientation') || (pageOrientationSelect ? pageOrientationSelect.value : 'portrait');
        let width = 320, height = 460;
        if (size === 'A4') { width = 420; height = 595; }
        else if (size === 'Letter') { width = 440; height = 570; }
        if (orientation === 'landscape') {
            const tmp = width; width = height; height = tmp;
        }
        page.style.width = width + 'px';
        page.style.height = height + 'px';
    }
    window.applyPageSizeOrientation = applyPageSizeOrientation;
    // Update current page on control change
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            if (window.pages && typeof window.currentPageIndex !== 'undefined' && window.pages[window.currentPageIndex]) {
                const page = window.pages[window.currentPageIndex];
                page.setAttribute('data-page-size', pageSizeSelect.value);
                applyPageSizeOrientation(page);
            }
        });
    }
    if (pageOrientationSelect) {
        pageOrientationSelect.addEventListener('change', function() {
            if (window.pages && typeof window.currentPageIndex !== 'undefined' && window.pages[window.currentPageIndex]) {
                const page = window.pages[window.currentPageIndex];
                page.setAttribute('data-orientation', pageOrientationSelect.value);
                applyPageSizeOrientation(page);
            }
        });
    }
    // Apply size/orientation when switching pages
    const origShowPage = window.showPage;
    window.showPage = function(index, direction) {
        if (typeof origShowPage === 'function') origShowPage(index, direction);
        if (window.pages && typeof window.currentPageIndex !== 'undefined' && window.pages[window.currentPageIndex]) {
            applyPageSizeOrientation(window.pages[window.currentPageIndex]);
        }
    };
    // Apply to all pages on load
    if (window.pages) {
        window.pages.forEach(applyPageSizeOrientation);
    }

    // Preview modal logic
    previewButton.addEventListener('click', () => {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = '';

        // Create WYSIWYG preview pages
        pages.forEach((page, idx) => {
            const clone = page.cloneNode(true);
            clone.classList.remove('active');
            clone.style.position = 'relative';
            clone.style.width = page.style.width || '320px';
            clone.style.height = page.style.height || '460px';
            clone.style.margin = '0 8px 20px 8px';
            clone.style.transform = 'none';
            clone.style.boxShadow = '0 8px 16px rgba(0,0,0,0.25)';
            clone.style.border = '2px solid #bbb';
            clone.style.borderRadius = '12px';
            clone.setAttribute('draggable', 'true');
            clone.classList.add('draggable-preview-page');
            clone.dataset.idx = idx;
            // Copy background color and image
            clone.style.backgroundColor = page.style.backgroundColor;
            clone.style.backgroundImage = page.style.backgroundImage;
            clone.style.backgroundSize = page.style.backgroundSize;
            clone.style.backgroundRepeat = page.style.backgroundRepeat;
            clone.style.backgroundPosition = page.style.backgroundPosition;
            // Copy page size/orientation attributes
            clone.setAttribute('data-page-size', page.getAttribute('data-page-size'));
            clone.setAttribute('data-orientation', page.getAttribute('data-orientation'));
            // Remove interactjs listeners & controls from cloned images for preview
            clone.querySelectorAll('.resizable').forEach(img => {
                img.style.cursor = 'default';
                const controls = img.querySelector('.image-controls');
                if (controls) controls.remove();
                const removeBtn = img.querySelector('.remove-btn');
                if (removeBtn) removeBtn.remove();
                // Ensure image position, size, float, and z-index are preserved
                img.style.position = page.querySelector('.resizable').style.position;
                img.style.top = page.querySelector('.resizable').style.top;
                img.style.left = page.querySelector('.resizable').style.left;
                img.style.width = page.querySelector('.resizable').style.width;
                img.style.height = page.querySelector('.resizable').style.height;
                img.style.zIndex = page.querySelector('.resizable').style.zIndex;
                img.style.float = page.querySelector('.resizable').style.float;
                img.style.margin = page.querySelector('.resizable').style.margin;
            });
            // Disable editing in preview
            const pageBody = clone.querySelector('.page-body');
            pageBody.contentEditable = false;
            previewContent.appendChild(clone);
        });

        // Drag and drop logic for rearranging preview pages
        let dragSrc = null;
        previewContent.querySelectorAll('.draggable-preview-page').forEach(pageEl => {
            pageEl.addEventListener('dragstart', function(e) {
                dragSrc = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.outerHTML);
                this.classList.add('dragging');
            });
            pageEl.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
            });
            pageEl.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            pageEl.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    // Swap nodes
                    const srcIdx = parseInt(dragSrc.dataset.idx);
                    const tgtIdx = parseInt(this.dataset.idx);
                    // Rearrange pages array
                    const temp = pages[srcIdx];
                    pages[srcIdx] = pages[tgtIdx];
                    pages[tgtIdx] = temp;
                    // Re-render preview
                    previewButton.click();
                }
                return false;
            });
        });

        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        previewModal.show();
    });

    document.addEventListener('DOMContentLoaded', function() {
        // --- Ensure all editor globals and at least one page exist ---
        if (!window.pages || !Array.isArray(window.pages)) window.pages = [];
        if (typeof window.createPage !== 'function') {
            window.createPage = createPage;
        }
        if (typeof window.addImageToPage !== 'function') {
            window.addImageToPage = addImageToPage;
        }
        if (typeof window.serializeBook !== 'function') {
            window.serializeBook = function() {
                return JSON.stringify(window.pages.map(page => {
                    // Serialize text and images for each page
                    const pageBody = page.querySelector('.page-body');
                    return {
                        html: pageBody ? pageBody.innerHTML : '',
                        images: Array.from(page.querySelectorAll('.resizable')).map(imgContainer => {
                            const img = imgContainer.querySelector('img');
                            return {
                                src: img ? img.src : '',
                                style: imgContainer.getAttribute('style'),
                                zIndex: imgContainer.style.zIndex || '20',
                                dataX: imgContainer.getAttribute('data-x') || '0',
                                dataY: imgContainer.getAttribute('data-y') || '0',
                            };
                        }),
                        bgColor: page.style.backgroundColor || '#fff',
                        bgImage: page.style.backgroundImage || '',
                        pageSize: page.getAttribute('data-page-size') || 'A5',
                        orientation: page.getAttribute('data-orientation') || 'portrait'
                    };
                }));
            };
        }
        if (typeof window.deserializeBook !== 'function') {
            window.deserializeBook = function(serialized) {
                let data;
                try { data = JSON.parse(serialized); } catch { return; }
                if (!Array.isArray(data)) return;
                // Remove all current pages
                while (window.pages.length > 0) {
                    const p = window.pages.pop();
                    if (p.parentNode) p.parentNode.removeChild(p);
                }
                data.forEach(pageData => {
                    const page = createPage();
                    const pb = page.querySelector('.page-body');
                    pb.innerHTML = pageData.html || '';
                    page.style.backgroundColor = pageData.bgColor || '#fff';
                    page.style.backgroundImage = pageData.bgImage || '';
                    page.setAttribute('data-page-size', pageData.pageSize || 'A5');
                    page.setAttribute('data-orientation', pageData.orientation || 'portrait');
                    // Add images
                    (pageData.images || []).forEach(imgData => {
                        const imgContainer = createResizableImage(imgData.src);
                        imgContainer.style = imgData.style || '';
                        imgContainer.style.zIndex = imgData.zIndex || '20';
                        imgContainer.setAttribute('data-x', imgData.dataX);
                        imgContainer.setAttribute('data-y', imgData.dataY);
                        applyTransform(imgContainer, parseFloat(imgData.dataX), parseFloat(imgData.dataY));
                        page.appendChild(imgContainer);
                        enableInteract(imgContainer);
                    });
                    window.pages.push(page);
                    window.bookContainer.appendChild(page);
                });
                if (window.pages.length > 0) {
                    window.pages.forEach(p => p.classList.remove('active'));
                    window.pages[0].classList.add('active');
                    window.currentPageIndex = 0;
                }
                if (typeof updatePageControls === 'function') updatePageControls();
                if (typeof saveState === 'function') saveState();
            };
        }
        if (!window.bookContainer) {
            window.bookContainer = document.getElementById('book-page-container');
        }
        // --- NEW: Always load storyContent if present (for edit) ---
        if (window.storyContent && Array.isArray(window.storyContent)) {
            window.deserializeBook(JSON.stringify(window.storyContent));
        } else if (window.pages.length === 0 && window.bookContainer) {
            // Always start with one page if none exist
            const page = createPage();
            window.pages.push(page);
            window.bookContainer.appendChild(page);
            page.classList.add('active');
            window.currentPageIndex = 0;
        }
        // --- Ensure correct page size/orientation is applied on load ---
        if (window.pages && window.pages.length > 0) {
            window.pages.forEach(p => {
                if (typeof window.applyPageSizeOrientation === 'function') {
                    window.applyPageSizeOrientation(p);
                }
            });
        }
        if (typeof updatePageControls === 'function') updatePageControls();
    });
    // --- Fix preview modal cleanup ---
    document.addEventListener('DOMContentLoaded', function() {
        const previewModal = document.getElementById('previewModal');
        if (previewModal) {
            previewModal.addEventListener('hidden.bs.modal', function() {
                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            });
        }
    });
    // --- Always show Street View if possible ---
    function showPlaceImages(place) {
        const imagesDiv = document.getElementById('maps-images');
        imagesDiv.innerHTML = '';
        function addImageWithButton(imgSrc, altText) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'inline-block';
            wrapper.style.position = 'relative';
            wrapper.style.marginRight = '8px';
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Inserted Image';
        img.style.pointerEvents = 'none';
        img.style.display = 'block';
        img.style.background = 'rgba(255,255,255,0.85)';
        container.appendChild(img);

        // Remove button (always visible, above border)
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '&times;';
        removeBtn.classList.add('remove-btn');
        removeBtn.title = 'Remove Image';
        removeBtn.style.zIndex = 100;
        removeBtn.style.position = 'absolute';
        removeBtn.style.top = '-18px';
        removeBtn.style.right = '-18px';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            container.remove();
            saveState();
        });
        container.appendChild(removeBtn);

        // Layer controls container
        const controls = document.createElement('div');
        controls.className = 'image-controls';

        const bringForwardBtn = document.createElement('button');
        bringForwardBtn.title = 'Bring Forward';
        bringForwardBtn.innerHTML = '<i class="bi bi-arrow-up"></i>';
        bringForwardBtn.type = 'button';
        bringForwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            container.style.zIndex = currentZ + 1;
            saveState();
        });

        const sendBackwardBtn = document.createElement('button');
        sendBackwardBtn.title = 'Send Backward';
        sendBackwardBtn.innerHTML = '<i class="bi bi-arrow-down"></i>';
        sendBackwardBtn.type = 'button';
        sendBackwardBtn.addEventListener('click', e => {
            e.stopPropagation();
            let currentZ = parseInt(container.style.zIndex) || 20;
            if (currentZ > 1) container.style.zIndex = currentZ - 1;
            saveState();
        });

        controls.appendChild(bringForwardBtn);
        controls.appendChild(sendBackwardBtn);
        container.appendChild(controls);

        // Ensure image is always behind text
        container.style.zIndex = 1;
        img.style.zIndex = 1;

        return container;
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.innerHTML = '<i class="bi bi-book me-1"></i> Add image to story';
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Ensure there is at least one page and a valid currentPageIndex
                window.pages = window.pages || [];
                // Find the book pages container robustly
                let bookPagesDiv = document.getElementById('book-pages');
                if (!bookPagesDiv) {
                    // Try to find by class as fallback
                    bookPagesDiv = document.querySelector('.book-pages, .book-pages-container');
                }
                if (!window.pages.length) {
                    if (typeof window.createPage === 'function' && bookPagesDiv) {
                        const newPage = window.createPage();
                        bookPagesDiv.appendChild(newPage);
                        window.pages.push(newPage);
                        window.currentPageIndex = 0;
                    } else {
                        alert('No pages available and cannot create a new page.');
                        return;
                    }
                } else if (typeof window.currentPageIndex === 'undefined' || window.currentPageIndex === null || !window.pages[window.currentPageIndex]) {
                    window.currentPageIndex = 0;
                }
                if (typeof window.addImageToPage === 'function') {
                    window.addImageToPage(imgSrc);
                } else {
                    alert('Image could not be added: editor not ready.');
                }
            });
            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            imagesDiv.appendChild(wrapper);
        }
        // Street View
        if (place.geometry && place.geometry.location) {
            const lat = place.geometry.location.lat ? place.geometry.location.lat() : place.geometry.location.lat;
            const lng = place.geometry.location.lng ? place.geometry.location.lng() : place.geometry.location.lng;
            const svImgSrc = `https://maps.googleapis.com/maps/api/streetview?size=400x200&location=${lat},${lng}&key=AIzaSyCg__vEXmZNhrmTCQhJqDgpUkf0nzzo3MM`;
            addImageWithButton(svImgSrc, 'Street View');
        }
        // Place Photos
        if (place.photos && place.photos.length > 0) {
            place.photos.forEach(photo => {
                const imgSrc = photo.getUrl({maxWidth:400, maxHeight:200});
                addImageWithButton(imgSrc, 'Place Photo');
            });
        }
        if (imagesDiv.children.length === 0) {
            imagesDiv.innerHTML = '<div class="text-danger">No images found for this place.</div>';
        }
    }
})(); // End IIFE
</script>
{% endblock %}
